<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Página de Testes de Overlays (OBS)</title>

  <style>
    :root{
      --bg:#0b0f1a;
      --card: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --accent:#60a5fa;
      --warn:#f59e0b;
      --ok:#22c55e;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(96,165,250,0.25), transparent),
        radial-gradient(900px 500px at 90% 30%, rgba(245,158,11,0.18), transparent),
        var(--bg);
      color: var(--text);
      min-height:100vh;
      padding: 26px;
    }

    header{
      max-width: 1300px;
      margin: 0 auto 18px;
      display:flex;
      gap: 14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{ margin:0; font-size: 26px; letter-spacing:0.2px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:14px; }

    .pill{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.22);
      padding: 10px 12px;
      border-radius: 999px;
      display:flex;
      gap:10px;
      align-items:center;
      max-width: 100%;
    }
    .pill label{ font-size:12px; color:var(--muted); }
    .pill input{
      width: 420px;
      max-width: 70vw;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 13px;
    }

    .grid{
      max-width: 1300px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(0,0,0,0.12));
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 22px 70px rgba(0,0,0,0.35);
      overflow:hidden;
    }

    .topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .meta h2{
      margin:0 0 6px;
      font-size: 18px;
    }
    .meta .desc{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      line-height:1.35;
    }

    .tags{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      user-select:none;
    }

    .stageWrap{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      border-radius: 16px;
      padding: 12px;
    }

    /* PREVIEW RESPONSIVO: encaixa na largura do card */
    .iframeStage{
      position: relative;
      width: 100%;
      aspect-ratio: 1920 / 600; /* default; será ajustado via JS */
      height: auto;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.30);
    }
    .iframeStage iframe{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      display:block;
      background: transparent;
    }

    .form{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 580px){
      .form{ grid-template-columns: 1fr; }
    }

    .field{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field select{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }

    .actions{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }

    button{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 12px;
    }
    button.primary{
      border-color: rgba(96,165,250,0.45);
      background: rgba(96,165,250,0.16);
    }
    button.ok{
      border-color: rgba(34,197,94,0.45);
      background: rgba(34,197,94,0.14);
    }
    button.warn{
      border-color: rgba(245,158,11,0.55);
      background: rgba(245,158,11,0.14);
    }

    .sizepill{
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .sizepill select{
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 12px;
    }

    .out{
      margin-top: 12px;
      border: 1px dashed rgba(255,255,255,0.20);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 12px;
    }
    .out .label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .out .url{
      font-size: 13px;
      word-break: break-all;
      line-height: 1.35;
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      opacity: 0;
      pointer-events:none;
      transition: opacity 220ms ease;
      font-size: 13px;
      z-index: 9999;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>

<header>
  <div>
    <h1>Página de Testes de Overlays (OBS)</h1>
    <div class="sub">Escolhe uma animação, ajusta os campos e copia o link final. O preview encaixa sempre no card.</div>
  </div>

  <div class="pill">
    <label for="domain">Domain</label>
    <input id="domain" type="text" value="http://localhost:3900" />
  </div>
</header>

<div class="grid" id="grid"></div>

<div class="toast" id="toast">Copiado ✅</div>

<script>
  // =========================
  // Config
  // =========================

  const ANIMS = [
    {
      id: 'votacao_sim_nao',
      name: 'Votação ao Vivo (Sim / Não) — amCharts',
      desc: 'Gráfico circular para Sim/Não. Lê via wordcloud. Parâmetros yes/no e domain.',
      baseUrl: 'https://votacao-ao-vivo.vercel.app/',
      tags: ['Sim/Não','amCharts','wordcloud'],
      params: [
        { key:'yes', label:'Texto Sim', type:'text', def:'Sim' },
        { key:'no',  label:'Texto Não', type:'text', def:'Não' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('yes', v.yes);
        q.set('no', v.no);
        q.set('domain', domain);
        return q;
      },
      resetWords: (v) => `${v.yes},${v.no}`
    },

    {
      id: 'poll4_abcd',
      name: 'Poll 4 (A/B/C/D) — barras',
      desc: 'Pergunta + 4 opções. Lê via wordcloud (A,B,C,D).',
      baseUrl: 'https://votacoes.vercel.app/',
      tags: ['A/B/C/D','barras','wordcloud'],
      params: [
        { key:'title', label:'Título', type:'text', def:'Qual escolhes?' },
        { key:'a', label:'Opção A', type:'text', def:'Opção A' },
        { key:'b', label:'Opção B', type:'text', def:'Opção B' },
        { key:'c', label:'Opção C', type:'text', def:'Opção C' },
        { key:'d', label:'Opção D', type:'text', def:'Opção D' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('title', v.title);
        q.set('a', v.a);
        q.set('b', v.b);
        q.set('c', v.c);
        q.set('d', v.d);
        q.set('domain', domain);
        return q;
      },
      resetWords: () => `A,B,C,D`
    },

    {
      id: 'quizz2',
      name: 'Quizz Relâmpago (2 opções)',
      desc: 'Pergunta + 2 respostas com contagem e barras. Aceita votos A/B. Lê via wordcloud.',
      baseUrl: 'https://quizz-relampago.vercel.app/',
      tags: ['A/B','barras','wordcloud'],
      params: [
        { key:'question', label:'Pergunta', type:'text', def:'Qual escolhes?' },
        { key:'a', label:'Resposta A', type:'text', def:'Opção A' },
        { key:'b', label:'Resposta B', type:'text', def:'Opção B' },
        { key:'keyA', label:'Voto A (tecla)', type:'text', def:'A' },
        { key:'keyB', label:'Voto B (tecla)', type:'text', def:'B' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('question', v.question);
        q.set('a', v.a);
        q.set('b', v.b);
        q.set('keyA', v.keyA);
        q.set('keyB', v.keyB);
        q.set('domain', domain);
        return q;
      },
      resetWords: (v) => `${v.keyA},${v.keyB}`
    },

    {
      id: 'wordcloud_q',
      name: 'Pergunta + Comentários (mural)',
      desc: 'Mostra pergunta e comentários em tempo real (mural vertical).',
      baseUrl: 'https://questionandcomments.vercel.app/',
      tags: ['chat','mural','wordcloud'],
      params: [
        { key:'question', label:'Pergunta', type:'text', def:'Escreve no chat…' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('question', v.question);
        q.set('domain', domain);
        return q;
      }
    },

    {
      id: 'palavra',
      name: 'Palavra Secreta (traços + letras)',
      desc: 'Mostra só traços e revela letras quando aparecem nos comentários.',
      baseUrl: 'https://palavra-secreta-sage.vercel.app/',
      tags: ['puzzle','forca','wordcloud'],
      params: [
        { key:'title', label:'Título', type:'text', def:'Palavra Secreta' },
        { key:'word', label:'Palavra', type:'text', def:'LIDERANCA' },
        { key:'tries', label:'Tentativas', type:'number', def:'8' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('title', v.title);
        q.set('word', v.word);
        q.set('tries', v.tries);
        q.set('domain', domain);
        return q;
      }
    },

    {
      id: 'delay',
      name: 'Delay vs Orador (jogo do delay)',
      desc: 'Frases divertidas enquanto o chat chega.',
      baseUrl: 'https://delay-omega.vercel.app/',
      tags: ['humor','delay','wordcloud'],
      params: [
        { key:'title', label:'Título', type:'text', def:'Delay vs Orador' },
        { key:'seconds', label:'Segundos de delay', type:'number', def:'30' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('title', v.title);
        q.set('seconds', v.seconds);
        q.set('domain', domain);
        return q;
      }
    },

    {
      id: 'url',
      name: 'Website / URL (cartão animado)',
      desc: 'Overlay para divulgar um link.',
      baseUrl: 'https://url-six-ruddy.vercel.app/',
      tags: ['URL','callout'],
      params: [
        { key:'title', label:'Título', type:'text', def:'Vai ao site' },
        { key:'url', label:'URL', type:'text', def:'https://teusite.com' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('title', v.title);
        q.set('url', v.url);
        q.set('domain', domain);
        return q;
      }
    },

    {
      id: 'energia',
      name: 'Medidor de Energia da Live',
      desc: 'Barra de energia que cresce com comentários.',
      baseUrl: 'https://medidor-energia.vercel.app/',
      tags: ['energia','barra','wordcloud'],
      params: [
        { key:'title', label:'Título', type:'text', def:'Energia da Live' },
        { key:'max', label:'Comentários para encher', type:'number', def:'120' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('title', v.title);
        q.set('max', v.max);
        q.set('domain', domain);
        return q;
      }
    },

    {
      id: 'balanca',
      name: 'Balança (A vs B)',
      desc: 'Balança de decisão com emojis a crescer.',
      baseUrl: 'https://balanca-wheat.vercel.app/',
      tags: ['A/B','balança','wordcloud'],
      params: [
        { key:'question', label:'Pergunta', type:'text', def:'Balança de Decisão' },
        { key:'optionA', label:'Opção A', type:'text', def:'Opção A' },
        { key:'optionB', label:'Opção B', type:'text', def:'Opção B' },
        { key:'align', label:'Alinhamento', type:'text', def:'bottom' },
      ],
      build: (v, domain) => {
        const q = new URLSearchParams();
        q.set('question', v.question);
        q.set('optionA', v.optionA);
        q.set('optionB', v.optionB);
        q.set('align', v.align);
        q.set('domain', domain);
        return q;
      },
      resetWords: () => `A,B`
    }
  ];

  // =========================
  // Helpers
  // =========================
  const $grid = document.getElementById('grid');
  const $domain = document.getElementById('domain');
  const $toast = document.getElementById('toast');

  function toast(msg){
    $toast.textContent = msg;
    $toast.classList.add('show');
    setTimeout(()=> $toast.classList.remove('show'), 850);
  }

  function normalizeBaseUrl(u){
    return String(u || '').trim().replace(/\?[^]*$/,'').replace(/\/$/,'');
  }

  function buildUrl(baseUrl, query){
    const base = normalizeBaseUrl(baseUrl);
    const qs = query.toString();
    return qs ? `${base}/?${qs}` : `${base}/`;
  }

  function el(tag, attrs = {}, children = []){
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)){
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(c));
    return n;
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      return true;
    }
  }

  async function clearChat(domain, words){
    const base = String(domain || '').trim().replace(/\/$/, '');
    const url = (words && String(words).trim())
      ? `${base}/clear-chat?words=${encodeURIComponent(words)}`
      : `${base}/clear-chat`;

    // Nota: se estiveres em https e o domain for http, o browser pode bloquear.
    // Ainda assim, em no-cors costuma “passar”, mas sem feedback real.
    try{
      await fetch(url, { mode:'no-cors' });
      return true;
    }catch{
      window.open(url, '_blank', 'noopener,noreferrer');
      return true;
    }
  }

  // =========================
  // Card builder
  // =========================
  function buildCard(anim){
    const meta = el('div', { class:'meta' }, [
      el('h2', { text: anim.name }),
      el('p', { class:'desc', text: anim.desc }),
      el('div', { class:'tags' }, (anim.tags||[]).map(t => el('span', { class:'tag', text:t })))
    ]);

    const baseField = el('div', { class:'field' }, [
      el('label', { text:'Base URL (podes trocar para o teu Vercel)' }),
    ]);
    const baseInput = el('input', { type:'text', value: anim.baseUrl });
    baseField.appendChild(baseInput);

    const form = el('div', { class:'form' }, [baseField]);
    const inputs = {};

    (anim.params || []).forEach(p => {
      const f = el('div', { class:'field' }, [
        el('label', { text: p.label }),
      ]);
      const i = el('input', { type: p.type || 'text', value: (p.def ?? '') });
      inputs[p.key] = i;
      f.appendChild(i);
      form.appendChild(f);
    });

    // Preview
    const iframeStage = el('div', { class:'iframeStage' }, []);
    const iframe = el('iframe', { allow:'autoplay' });
    iframeStage.appendChild(iframe);

    const sizeSel = el('select', {}, [
      el('option', { value:'1920x600', text:'1920×600' }),
      el('option', { value:'1920x1080', text:'1920×1080' }),
    ]);

    function applyStageSize(){
      const [w, h] = String(sizeSel.value || '1920x600').split('x').map(n => parseInt(n, 10));
      iframeStage.style.aspectRatio = `${w} / ${h}`;
    }

    // Output URL (para copiar)
    const out = el('div', { class:'out' }, [
      el('div', { class:'label', text:'Link final (OBS Browser Source)' }),
      el('div', { class:'url', text:'' }),
    ]);
    const outUrl = out.querySelector('.url');

    function getVals(){
      const v = {};
      (anim.params || []).forEach(p => v[p.key] = (inputs[p.key]?.value ?? ''));
      return v;
    }

    function compute(){
      const domain = ($domain.value || '').trim() || 'http://localhost:3900';
      const base = (baseInput.value || anim.baseUrl).trim();
      const vals = getVals();
      const query = anim.build(vals, domain);
      const url = buildUrl(base, query);
      outUrl.textContent = url;
      iframe.src = url;
      return { url, domain, vals };
    }

    // Actions
    const btnCopy = el('button', { class:'ok', text:'Copiar link' });
    btnCopy.addEventListener('click', async () => {
      const { url } = compute();
      await copyText(url);
      toast('Copiado ✅');
    });

    const btnOpen = el('button', { class:'primary', text:'Abrir num separador' });
    btnOpen.addEventListener('click', () => {
      const { url } = compute();
      window.open(url, '_blank', 'noopener');
    });

    const btnResetFields = el('button', { text:'Reset campos' });
    btnResetFields.addEventListener('click', () => {
      baseInput.value = anim.baseUrl;
      (anim.params || []).forEach(p => { inputs[p.key].value = (p.def ?? ''); });
      sizeSel.value = '1920x600';
      applyStageSize();
      compute();
      toast('Reset feito');
    });

    const btnResetWordcloud = el('button', { class:'warn', text:'Reset wordcloud' });
    btnResetWordcloud.addEventListener('click', async () => {
      const { domain, vals } = compute();
      const words = (typeof anim.resetWords === 'function') ? (anim.resetWords(vals) || '') : '';
      await clearChat(domain, words);
      toast('Reset feito ✅');
    });

    const sizepill = el('span', { class:'sizepill' }, [
      el('span', { text:'Preview' }),
      sizeSel
    ]);

    const actions = el('div', { class:'actions' }, [
      el('div', { class:'btnRow' }, [btnCopy, btnOpen, btnResetFields, sizepill, btnResetWordcloud]),
    ]);

    const hint = el('div', { class:'hint', html:
      'Dica: no OBS, ativa “Refresh cache of current page” quando estiveres a testar. Se esta página estiver em <b>https</b> e o domain for <b>http</b>, alguns browsers podem bloquear pedidos (mixed content).'
    });

    const stageWrap = el('div', { class:'stageWrap' }, [
      iframeStage,
      hint
    ]);

    // Wire events
    baseInput.addEventListener('input', compute);
    Object.values(inputs).forEach(i => i.addEventListener('input', compute));
    $domain.addEventListener('input', compute);

    sizeSel.addEventListener('change', () => {
      applyStageSize();
    });

    // Build card
    const card = el('div', { class:'card' }, [
      el('div', { class:'topline' }, [meta]),
      form,
      actions,
      out,
      stageWrap
    ]);

    // init
    applyStageSize();
    setTimeout(compute, 0);

    return card;
  }

  // Render
  ANIMS.forEach(a => $grid.appendChild(buildCard(a)));
</script>

</body>
</html>
